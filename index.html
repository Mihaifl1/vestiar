<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vestiar – 6 uși • MQTT live</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  :root{
    --bg:#0b1220; --wall:#e5e7eb;
    --closed:#22c55e;  /* verde  = ÎNCHIS/LOCKED */
    --open:#ef4444;    /* roșu   = DESCHIS/UNLOCKED */
    --nopower:#6b7280; /* gri    = Fără alimentare */
    --hinge:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0 0 10px}

  .legend{font-size:14px;opacity:.9;margin:8px 0 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend span{display:inline-block;padding:2px 8px;border-radius:6px}
  .legend .c{background:var(--closed)}
  .legend .o{background:var(--open)}
  .legend .p{background:var(--nopower)}
  .legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  .conn{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #334155;border-radius:8px;background:#0f172a}
  .conn .dot{background:#ef4444}
  .conn.ok .dot{background:#22c55e}

  .plan{
    position:relative; width:100%;
    border:10px solid var(--wall); border-radius:12px; overflow:hidden;
    background:#0b1220; user-select:none;
  }
  .plan-img{ display:block; width:100%; height:auto; }
  .overlay{ position:absolute; inset:0; pointer-events:auto; }

  /* UȘA (grup) */
  .door{
    position:absolute; left:0; top:0;
    --x: 0%; --y: 0%; --a: 0;
    transform: translate(var(--x), var(--y)) rotate(calc(var(--a) * 1deg));
    transform-origin: 0 0;
    width: 84px; height: 40px;
    cursor:pointer;
  }
  .door .hinge{
    position:absolute; top:6px; width:8px; height:20px;
    background:var(--hinge); border-radius:4px;
  }
  .door .leaf{
    position:absolute; top:8px; width:72px; height:10px;
    border:2px solid #000; border-radius:6px; background:var(--closed);
    transition: transform .25s ease, background .2s ease, box-shadow .2s ease;
    transform-origin: left center; box-shadow:0 0 0 rgba(0,0,0,0);
  }
  .door .label{
    position:absolute; left:-20px; top:30px;
    font-size:12px; font-weight:bold;
    color:#aad1ff;
    text-shadow:0 1px 2px rgba(0,0,0,.5);
    white-space:pre; /* permite \n */
  }

  .door[data-hinge="left"] .hinge{ left:-6px }
  .door[data-hinge="right"] .hinge{ right:-6px }
  .door[data-hinge="left"]  .leaf{ left:0;  transform-origin:left  center }
  .door[data-hinge="right"] .leaf{ right:0; transform-origin:right center }

  /* unghi de deschidere (60° implicit) */
  .door[data-hinge="left"][data-swing="down"].open .leaf{ transform: rotate(60deg);  background:var(--open); box-shadow:0 6px 10px rgba(0,0,0,.45) }
  .door[data-hinge="left"][data-swing="up"].open   .leaf{ transform: rotate(-60deg); background:var(--open); box-shadow:0 6px 10px rgba(0,0,0,.45) }
  .door[data-hinge="right"][data-swing="down"].open .leaf{ transform: rotate(-60deg); background:var(--open); box-shadow:0 6px 10px rgba(0,0,0,.45) }
  .door[data-hinge="right"][data-swing="up"].open   .leaf{ transform: rotate(60deg);  background:var(--open); box-shadow:0 6px 10px rgba(0,0,0,.45) }

  .door.nopower .leaf{ background:var(--nopower) }
</style>
</head>
<body>
<div class="wrap">
  <h1>Vestiar – control uși (MQTT)</h1>
<a href="programari.html" target="_blank" style="margin-left:8px;background:#0f172a;color:#fff;border:1px solid #334155;border-radius:8px;padding:6px 10px;text-decoration:none">
  ↗ Programări (orar)
</a>

  <div class="legend">
    <span class="c">ÎNCHIS (verde)</span>
    <span class="o">DESCHIS (roșu)</span>
    <span class="p">Fără alimentare (gri)</span>
    <span class="conn" id="conn"><span class="dot"></span><span id="connText">Se conectează la MQTT…</span></span>
  </div>

  <div class="plan" id="plan">
    <img id="planImg" class="plan-img" src="vestiar.jpg" alt="Plan Vestiar">
    <div class="overlay" id="overlay">
      <!-- UȘI – poziții inițiale (le ajustezi în CONFIG mai jos) -->
      <div class="door" id="d1" data-hinge="left"  data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 1</div></div>
      <div class="door" id="d2" data-hinge="left"  data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 2</div></div>
      <div class="door" id="d3" data-hinge="left"  data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 3</div></div>
      <div class="door" id="d4" data-hinge="right" data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 4</div></div>
      <div class="door" id="d5" data-hinge="right" data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 5</div></div>
      <div class="door" id="d6" data-hinge="right" data-swing="up"><div class="hinge"></div><div class="leaf"></div><div class="label">Ușa 6</div></div>
    </div>
  </div>
</div>

<script>
/* ===========================
   1) CONFIG poziții (procente)
   – păstrate ca în varianta ta „fixă”
=========================== */
const CONFIG = {
  d1: { x: 137,  y: 220,  a: 0 },
  d2: { x: 270,  y: 220,  a: 0 },
  d3: { x: 430,  y: 220,  a: 0 },
  d4: { x: 1100, y: 2700, a: 90 },
  d5: { x: 1100, y: 3000, a: 90 },
  d6: { x: 1100, y: 3360, a: 90 }
};
// NOTĂ: aici valorile sunt tratate ca PROCENTE.
// Dacă sunt prea mari, redu-le (ex: 13.7 în loc de 137).

/* Poziționare din CONFIG */
function applyConfig(){
  Object.keys(CONFIG).forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const {x,y,a} = CONFIG[id];
    el.style.setProperty('--x', (Number(x)||0) + '%');
    el.style.setProperty('--y', (Number(y)||0) + '%');
    el.style.setProperty('--a', (Number(a)||0));
  });
}
applyConfig();

/* ===========================
   2) MQTT – JSON status & comenzi
=========================== */
const brokerUrl = "wss://broker.emqx.io:8084/mqtt";
const options = {
  clientId: "web_" + Math.random().toString(16).slice(2),
  clean: true,
  reconnectPeriod: 2000,
};
const client = mqtt.connect(brokerUrl, options);

const connBadge = document.getElementById('conn');
const connText  = document.getElementById('connText');

client.on('connect', () => {
  connBadge.classList.add('ok');
  connText.textContent = 'MQTT conectat';
  // abonare la toate status-urile
  [1,2,3,4,5,6].forEach(i=>{
    client.subscribe(`locker/${i}/status`, {qos:0});
  });
});

client.on('reconnect', ()=>{ connBadge.classList.remove('ok'); connText.textContent = 'Reconectare MQTT…'; });
client.on('close', ()=>{ connBadge.classList.remove('ok'); connText.textContent = 'MQTT deconectat'; });
client.on('error', (e)=>{ connBadge.classList.remove('ok'); connText.textContent = 'Eroare MQTT'; console.error(e); });

/* map uși */
const DOORS = {
  1: { el: document.getElementById('d1'), cmd: 'locker/1/cmd' },
  2: { el: document.getElementById('d2'), cmd: 'locker/2/cmd' },
  3: { el: document.getElementById('d3'), cmd: 'locker/3/cmd' },
  4: { el: document.getElementById('d4'), cmd: 'locker/4/cmd' },
  5: { el: document.getElementById('d5'), cmd: 'locker/5/cmd' },
  6: { el: document.getElementById('d6'), cmd: 'locker/6/cmd' },
};

/* stare curentă primită de la ESP */
const state = {
  1:{lock:'LOCKED',door:'CLOSED',power:'ON'},
  2:{lock:'LOCKED',door:'CLOSED',power:'ON'},
  3:{lock:'LOCKED',door:'CLOSED',power:'ON'},
  4:{lock:'LOCKED',door:'CLOSED',power:'ON'},
  5:{lock:'LOCKED',door:'CLOSED',power:'ON'},
  6:{lock:'LOCKED',door:'CLOSED',power:'ON'},
};

function renderDoor(id){
  const s = state[id];
  const d = DOORS[id];
  if(!d) return;
  const el = d.el;
  // reset clase
  el.classList.remove('open','nopower');
  // power
  if(s.power === 'OFF'){ el.classList.add('nopower'); }
  // lock => animatia canatului (open = UNLOCKED)
  if(s.lock === 'UNLOCKED'){ el.classList.add('open'); }
  // label text
  const label = el.querySelector('.label');
  label.textContent = `Ușa ${id}\n${s.lock} / ${s.door}${s.power==='OFF' ? ' / NOPWR' : ''}`;
}

/* primire status JSON */
client.on('message', (topic, payload) => {
  try{
    const txt = payload.toString();
    const data = JSON.parse(txt);
    // extrage id: locker/X/status
    const parts = topic.split('/');
    const id = parseInt(parts[1],10);
    if(!state[id]) return;
    // actualizează stare (cu fallback)
    if(data.lock)  state[id].lock  = data.lock.toUpperCase();
    if(data.door)  state[id].door  = data.door.toUpperCase();
    if(data.power) state[id].power = data.power.toUpperCase();
    renderDoor(id);
  }catch(e){
    console.warn('Status invalid:', topic, payload.toString(), e);
  }
});

/* click pe ușă => trimite LOCK/UNLOCK
   - dacă power OFF, ignorăm comanda
   - logica toggle: dacă e LOCKED => UNLOCK, altfel LOCK
*/
Object.keys(DOORS).forEach(k=>{
  const id = parseInt(k,10);
  const {el, cmd} = DOORS[id];
  el.addEventListener('click', ()=>{
    const s = state[id];
    if(s.power === 'OFF'){ console.log(`Ușa ${id}: fără alimentare, ignor comanda.`); return; }
    const next = (s.lock === 'LOCKED') ? 'UNLOCK' : 'LOCK';
    client.publish(cmd, next);
    console.log(`Trimis ${next} -> ${cmd}`);
    // opțional: optimist până vine statusul
    // s.lock = (next==='LOCK' ? 'LOCKED' : 'UNLOCKED'); renderDoor(id);
  });
});

/* randare inițială */
[1,2,3,4,5,6].forEach(renderDoor);
</script>
</body>
</html>
