<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Control MQTT â€“ Vestiar & Depozit</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body {
    margin:0;
    background:#0b1220;
    color:white;
    font-family:Arial,sans-serif;
    text-align:center;
  }
  header {
    background:#111827;
    padding:15px;
    font-size:22px;
    color:#60a5fa;
    font-weight:bold;
  }
  .tabs {
    display:flex;
    justify-content:center;
    background:#1e293b;
    flex-wrap:wrap;
  }
  .tab {
    flex:1 1 50%;
    padding:14px;
    cursor:pointer;
    font-weight:bold;
    color:#9ca3af;
    border-bottom:3px solid transparent;
  }
  .tab.active {
    color:#fff;
    background:#2563eb;
    border-bottom:3px solid #3b82f6;
  }
  .tab-content { display:none; padding:20px; }
  .tab-content.active { display:block; }

  #status { font-size:15px; opacity:0.85; margin:10px 0; }

  .door {
    width:90%; max-width:320px;
    margin:12px auto; padding:16px;
    border-radius:12px;
    font-size:18px; font-weight:bold;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
    cursor:pointer;
    transition:transform 0.2s, background 0.3s;
  }
  .door:active { transform:scale(0.97); }

  /* culori stÄƒri */
  .inchisa-incuiata   { background:#16a34a; }  /* verde */
  .inchisa-descuiata  { background:#3b82f6; }  /* albastru */
  .deschisa-incuiata  { background:#f97316; }  /* portocaliu */
  .deschisa-descuiata { background:#ef4444; }  /* roÈ™u */
  .offline            { background:#6b7280; color:#ccc; } /* gri */

  #updateBtn {
    margin-top:20px;
    background:#2563eb;
    color:white;
    font-weight:bold;
    border:none;
    padding:12px 24px;
    border-radius:10px;
    font-size:16px;
    cursor:pointer;
    transition:background 0.3s;
  }
  #updateBtn:hover { background:#1d4ed8; }

  @media (max-width:600px){
    .door{font-size:17px; padding:12px;}
  }
</style>
</head>
<body>

<header>Control MQTT â€“ Vestiar & Depozit</header>

<div class="tabs">
  <div class="tab active" id="tab-vestiar">Vestiar</div>
  <div class="tab" id="tab-depozit">Depozit</div>
</div>

<div id="status">ðŸ”Œ Se conecteazÄƒ la broker MQTT...</div>

<!-- Vestiar -->
<div class="tab-content active" id="content-vestiar">
  <div id="doors"></div>
  <button id="updateBtn">ðŸ”„ UPDATE</button>
</div>

<!-- Depozit -->
<div class="tab-content" id="content-depozit">
  <div id="zones"></div>
</div>

<!-- Sunet -->
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
/* ===== TAB SWITCH ===== */
const tabVestiar=document.getElementById("tab-vestiar");
const tabDepozit=document.getElementById("tab-depozit");
const contentVestiar=document.getElementById("content-vestiar");
const contentDepozit=document.getElementById("content-depozit");
tabVestiar.onclick=()=>switchTab("vestiar");
tabDepozit.onclick=()=>switchTab("depozit");
function switchTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  if(tab==="vestiar"){tabVestiar.classList.add("active");contentVestiar.classList.add("active");}
  else{tabDepozit.classList.add("active");contentDepozit.classList.add("active");}
}

/* ===== MQTT CONFIG ===== */
const brokerUrl="wss://broker.emqx.io:8084/mqtt";
let client=null;
const statusEl=document.getElementById("status");
const OFFLINE_MS=20000;
const alertSound=document.getElementById("alertSound");

function connectMQTT(){
  if(client){ try{client.end(true);}catch(e){} }
  client=mqtt.connect(brokerUrl,{clientId:"web_"+Math.random().toString(16).slice(2)});
  statusEl.textContent="ðŸ”Œ Se conecteazÄƒ la broker MQTT...";

  client.on("connect",()=>{
    statusEl.textContent="ðŸŸ¢ Conectat la MQTT";
    Object.values(DOORS).forEach(d=>client.subscribe(d.status));
    Object.values(ZONES).forEach(z=>client.subscribe(z.status));
  });
  client.on("reconnect",()=>statusEl.textContent="ðŸŸ¡ Reconectare...");
  client.on("close",()=>statusEl.textContent="ðŸ”´ Deconectat");
  client.on("message",(topic,payload)=>{
    try{
      const data=JSON.parse(payload.toString());
      const [sect,id,typ]=topic.split("/");
      const n=parseInt(id,10);
      const obj=(sect==="locker"?DOORS[n]:ZONES[n]);
      if(!obj)return;
      if(data.lock)obj.lock=data.lock.toUpperCase();
      if(data.door)obj.door=data.door.toUpperCase();
      obj.last=Date.now();
      render(sect,n);
    }catch(e){console.warn("Eroare MQTT:",topic,payload.toString());}
  });
}
connectMQTT();

/* ===== ELEMENTE ===== */
const doorsDiv=document.getElementById("doors");
const zonesDiv=document.getElementById("zones");
const DOORS={},ZONES={};

for(let i=1;i<=6;i++){
  const el=document.createElement("div");
  el.className="door offline";
  el.textContent=`UÈ™a ${i} âšª OFFLINE`;
  doorsDiv.appendChild(el);
  DOORS[i]={el,cmd:`locker/${i}/cmd`,status:`locker/${i}/status`,last:0,lock:"LOCKED",door:"CLOSED"};
}
for(let i=1;i<=2;i++){
  const el=document.createElement("div");
  el.className="door offline";
  el.textContent=`Zona ${i} âšª OFFLINE`;
  zonesDiv.appendChild(el);
  ZONES[i]={el,cmd:`depozit/${i}/cmd`,status:`depozit/${i}/status`,last:0,lock:"LOCKED",door:"CLOSED"};
}

/* ===== RANDARE ===== */
function render(section,id){
  const obj=section==="locker"?DOORS[id]:ZONES[id];
  const el=obj.el;
  const off=(Date.now()-obj.last>OFFLINE_MS);
  el.className="door";
  if(off){
    el.classList.add("offline");
    el.textContent=`${section==="locker"?"UÈ™a":"Zona"} ${id} âšª OFFLINE`;
    return;
  }

  const door=obj.door;
  const lock=obj.lock;

  if(door==="CLOSED" && lock==="LOCKED"){
    el.classList.add("inchisa-incuiata");
    el.textContent=`${section==="locker"?"UÈ™a":"Zona"} ${id} ðŸ”’ ÃŽnchisÄƒ È™i Ã®ncuiatÄƒ`;
  }
  else if(door==="CLOSED" && lock==="UNLOCKED"){
    el.classList.add("inchisa-descuiata");
    el.textContent=`${section==="locker"?"UÈ™a":"Zona"} ${id} ðŸ”“ ÃŽnchisÄƒ È™i descuiatÄƒ`;
  }
  else if(door==="OPEN" && lock==="LOCKED"){
    el.classList.add("deschisa-incuiata");
    el.textContent=`${section==="locker"?"UÈ™a":"Zona"} ${id} ðŸŸ  DeschisÄƒ È™i Ã®ncuiatÄƒ`;
    alertSound.play().catch(()=>{}); // ðŸŽµ RedÄƒ sunetul de avertizare
  }
  else if(door==="OPEN" && lock==="UNLOCKED"){
    el.classList.add("deschisa-descuiata");
    el.textContent=`${section==="locker"?"UÈ™a":"Zona"} ${id} ðŸšª DeschisÄƒ È™i descuiatÄƒ`;
  }
}

/* ===== CLICK ===== */
Object.keys(DOORS).forEach(k=>{
  const id=parseInt(k);
  DOORS[id].el.onclick=()=>toggle("locker",id);
});
Object.keys(ZONES).forEach(k=>{
  const id=parseInt(k);
  ZONES[id].el.onclick=()=>toggle("depozit",id);
});
function toggle(section,id){
  const obj=section==="locker"?DOORS[id]:ZONES[id];
  const off=(Date.now()-obj.last>OFFLINE_MS);
  if(off)return;
  const next=obj.lock==="LOCKED"?"UNLOCK":"LOCK";
  client.publish(obj.cmd,next);
  statusEl.textContent=`ðŸ” Trimis ${next} â†’ ${section} ${id}`;
}

/* ===== AUTO UPDATE LA FIECARE 5 SECUNDE ===== */
setInterval(()=>{
  if(!client || client.disconnected){
    console.log("Auto-update MQTT...");
    statusEl.textContent="ðŸ” Auto-update...";
    connectMQTT();
  } else {
    Object.keys(DOORS).forEach(i=>render("locker",i));
    Object.keys(ZONES).forEach(i=>render("depozit",i));
  }
},5000);

/* ===== BUTON UPDATE MANUAL ===== */
document.getElementById("updateBtn").onclick=()=>{
  statusEl.textContent="ðŸ”„ Se reconecteazÄƒ...";
  connectMQTT();
};
</script>
</body>
</html>
