<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Vestiar & Depozit Control</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0b1220;
    color: white;
    text-align: center;
    margin: 0;
  }

  header {
    background: #111827;
    padding: 15px;
    color: #60a5fa;
    font-size: 22px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  .tabs {
    display: flex;
    justify-content: center;
    background: #1e293b;
  }

  .tab {
    flex: 1;
    padding: 14px;
    cursor: pointer;
    font-weight: bold;
    color: #9ca3af;
    border-bottom: 3px solid transparent;
  }
  .tab.active {
    color: #fff;
    background: #2563eb;
    border-bottom: 3px solid #3b82f6;
  }

  .tab-content { display:none; padding:20px; }
  .tab-content.active { display:block; }

  .door, .zone {
    display:flex;
    justify-content:center;
    align-items:center;
    width:80%;
    max-width:320px;
    margin:12px auto;
    padding:15px;
    border-radius:12px;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    transition: background 0.3s, transform 0.2s;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  .door.locked, .zone.locked   { background:#16a34a; }
  .door.unlocked, .zone.unlocked { background:#dc2626; }
  .door.offline, .zone.offline { background:#6b7280; }

  .door:active, .zone:active { transform: scale(0.97); }

  #status { margin-top:20px; font-size:16px; opacity:0.9; }
</style>
</head>
<body>
  <header>Control MQTT</header>

  <div class="tabs">
    <div class="tab active" id="tab-vestiar">Vestiar</div>
    <div class="tab" id="tab-depozit">Depozit</div>
  </div>

  <!-- TAB VESTIAR -->
  <div class="tab-content active" id="content-vestiar">
    <h2>Control Vestiar</h2>
    <div id="doors"></div>
  </div>

  <!-- TAB DEPOZIT -->
  <div class="tab-content" id="content-depozit">
    <h2>Acces Depozit</h2>
    <div id="zones"></div>
  </div>

  <div id="status">ðŸ”Œ Se conecteazÄƒ la broker MQTT...</div>

<script>
/* ======== TAB SWITCH ======== */
const tabVestiar = document.getElementById("tab-vestiar");
const tabDepozit = document.getElementById("tab-depozit");
const contentVestiar = document.getElementById("content-vestiar");
const contentDepozit = document.getElementById("content-depozit");

tabVestiar.onclick = () => switchTab("vestiar");
tabDepozit.onclick = () => switchTab("depozit");

function switchTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  if(tab==="vestiar"){ tabVestiar.classList.add("active"); contentVestiar.classList.add("active"); }
  else { tabDepozit.classList.add("active"); contentDepozit.classList.add("active"); }
}

/* ======== MQTT SETUP ======== */
const brokerUrl = "wss://broker.emqx.io:8084/mqtt";
const options = { clientId: "web_" + Math.random().toString(16).slice(2) };
const client = mqtt.connect(brokerUrl, options);
const statusEl = document.getElementById("status");
const OFFLINE_MS = 20000;

/* ======== CREARE ELEMENTE ======== */
const doorsDiv = document.getElementById("doors");
const zonesDiv = document.getElementById("zones");
const DOORS = {};
const ZONES = {};
for(let i=1;i<=6;i++){
  const el = document.createElement("div");
  el.id = "door"+i;
  el.className = "door offline";
  el.textContent = `UÈ™a ${i} âšª OFFLINE`;
  doorsDiv.appendChild(el);
  DOORS[i] = {el, cmd:`locker/${i}/cmd`, status:`locker/${i}/status`, last:0, lock:"LOCKED", power:"ON"};
}
for(let i=1;i<=2;i++){
  const el = document.createElement("div");
  el.id = "zone"+i;
  el.className = "zone offline";
  el.textContent = `Depozit Zona ${i} âšª OFFLINE`;
  zonesDiv.appendChild(el);
  ZONES[i] = {el, cmd:`depozit/${i}/cmd`, status:`depozit/${i}/status`, last:0, lock:"LOCKED", power:"ON"};
}

/* ======== CONEXIUNE MQTT ======== */
client.on("connect", ()=>{
  statusEl.textContent = "ðŸŸ¢ Conectat la MQTT";
  Object.keys(DOORS).forEach(i=>client.subscribe(DOORS[i].status));
  Object.keys(ZONES).forEach(i=>client.subscribe(ZONES[i].status));
});
client.on("reconnect", ()=>statusEl.textContent="ðŸŸ¡ Reconectare...");
client.on("close", ()=>statusEl.textContent="ðŸ”´ Deconectat");

/* ======== MESAJ STATUS ======== */
client.on("message",(topic,payload)=>{
  try{
    const txt = payload.toString();
    const data = JSON.parse(txt);
    const [sect,id,typ] = topic.split("/");
    const n = parseInt(id,10);
    const obj = sect==="locker"?DOORS[n]:ZONES[n];
    if(!obj) return;
    if(data.lock) obj.lock=data.lock.toUpperCase();
    if(data.power) obj.power=data.power.toUpperCase();
    obj.last=Date.now();
    render(sect,n);
  }catch(e){ console.warn("Status invalid:",topic,payload.toString()); }
});

/* ======== RANDARE STARE ======== */
function render(section,id){
  const obj = section==="locker"?DOORS[id]:ZONES[id];
  const el = obj.el;
  const off = (Date.now()-obj.last>OFFLINE_MS);
  el.classList.remove("locked","unlocked","offline");
  if(off){
    el.classList.add("offline");
    el.textContent = (section==="locker"?`UÈ™a ${id}`:`Depozit Zona ${id}`)+" âšª OFFLINE";
  }else if(obj.lock==="LOCKED"){
    el.classList.add("locked");
    el.textContent = (section==="locker"?`UÈ™a ${id}`:`Depozit Zona ${id}`)+" ðŸ”’ LOCKED";
  }else{
    el.classList.add("unlocked");
    el.textContent = (section==="locker"?`UÈ™a ${id}`:`Depozit Zona ${id}`)+" ðŸ”“ UNLOCKED";
  }
}

/* ======== CLICK = TOGGLE LOCK ======== */
Object.keys(DOORS).forEach(k=>{
  const id=parseInt(k);
  DOORS[id].el.onclick=()=>toggle("locker",id);
});
Object.keys(ZONES).forEach(k=>{
  const id=parseInt(k);
  ZONES[id].el.onclick=()=>toggle("depozit",id);
});

function toggle(section,id){
  const obj = section==="locker"?DOORS[id]:ZONES[id];
  const off = (Date.now()-obj.last>OFFLINE_MS);
  if(off) return console.log(`${section} ${id} este offline`);
  const next = obj.lock==="LOCKED"?"UNLOCK":"LOCK";
  client.publish(obj.cmd,next);
  statusEl.textContent=`ðŸšª Trimis ${next} â†’ ${section} ${id}`;
}

/* ======== WATCHDOG ======== */
setInterval(()=>{
  Object.keys(DOORS).forEach(i=>render("locker",i));
  Object.keys(ZONES).forEach(i=>render("depozit",i));
},2000);
</script>
</body>
</html>
