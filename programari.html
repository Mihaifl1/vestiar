<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Programări uși – MQTT (debug)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  :root{ --bg:#0b1220; --card:#0f172a; --bd:#334155; --ok:#22c55e; --warn:#f59e0b; --txt:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0 0 12px}
  .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .conn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);background:var(--card);padding:6px 10px;border-radius:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}
  .ok{background:var(--ok)}
  select,button,input[type="time"],input[type="text"]{
    background:var(--card);color:var(--txt);border:1px solid var(--bd);border-radius:8px;padding:6px 10px
  }
  .panel{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .rules{display:grid;grid-template-columns: 1.5fr 0.8fr 0.8fr 0.6fr 0.3fr;gap:8px;align-items:center}
  .rules .hdr{font-weight:700;opacity:.9}
  .days{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--bd);border-radius:999px}
  .chip input{accent-color:#60a5fa}
  .del{background:#172036;border:1px solid var(--bd);border-radius:8px;padding:6px 8px;cursor:pointer}
  .bottom{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .status{min-height:22px}
  .good{color:var(--ok)} .warn{color:var(--warn)}
  .note{opacity:.8;font-size:12px;margin-top:8px}
  pre.debug{background:#071022;border:1px solid #122233;padding:8px;border-radius:8px;color:#cbd5e1;max-height:180px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>Programări pentru uși (MQTT) — DEBUG</h1>

  <div class="top">
    <div class="conn" id="conn"><span class="dot" id="dot"></span><span id="connText">Se conectează la MQTT…</span></div>
    <a href="index.html" style="margin-left:auto;color:#93c5fd">⟵ Înapoi la hartă</a>
  </div>

  <div class="panel">
    <div class="toolbar">
      <label>Ușă:</label>
      <select id="doorSel">
        <option value="1">Ușa 1</option><option value="2">Ușa 2</option><option value="3">Ușa 3</option>
        <option value="4">Ușa 4</option><option value="5">Ușa 5</option><option value="6">Ușa 6</option>
      </select>

      <button id="addBtn">Adaugă regulă</button>
      <button id="saveBtn">Salvează în ESP</button>
      <button id="loadBtn">Încarcă din ESP</button>
      <button id="clearBtn">Șterge toate</button>
      <button id="exampleBtn">Exemplu (L–V)</button>
      <button id="copyBtn">Aplică la toate</button>
      <button id="printBtn">Print JSON</button>
      <span class="status" id="statusMsg"></span>
    </div>

    <div class="rules" id="rulesHdr">
      <div class="hdr">Zile</div>
      <div class="hdr">Ora</div>
      <div class="hdr">Acțiune</div>
      <div class="hdr">Notă</div>
      <div class="hdr"></div>
    </div>
    <div class="rules" id="rules"></div>

    <div class="note">
      Formatul trimis pe MQTT: <code>{"rules":[{"days":[0,1,2,3,4],"time":"08:00","action":"UNLOCK"}...]}</code>
      (0=Luni … 6=Duminică)
    </div>

    <h3 style="margin-top:12px">Debug / Preview</h3>
    <pre class="debug" id="debugDump">—</pre>
  </div>
</div>

<script>
/* ===== MQTT minimal ===== */
const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", { clientId:"sched_"+Math.random().toString(16).slice(2) });
const connText = document.getElementById('connText'); const dot = document.getElementById('dot');

client.on('connect', ()=>{ dot.classList.add('ok'); connText.textContent='MQTT conectat'; subscribeForCurrent(); flash('MQTT conectat', true); });
client.on('reconnect', ()=>{ dot.classList.remove('ok'); connText.textContent='Reconectare…'; flash('Reconectare MQTT...', false); });
client.on('close', ()=>{ dot.classList.remove('ok'); connText.textContent='MQTT închis'; flash('MQTT închis', false); });

function subscribeForCurrent(){
  [1,2,3,4,5,6].forEach(i=> client.subscribe(`locker/${i}/schedule`));
}

/* ===== Stocare reguli per ușă ===== */
let allRules = {1:[],2:[],3:[],4:[],5:[],6:[]};
const dayNames = ['Lu','Ma','Mi','Jo','Vi','Sa','Du'];

const rulesEl  = document.getElementById('rules');
const doorSel  = document.getElementById('doorSel');
const addBtn   = document.getElementById('addBtn');
const saveBtn  = document.getElementById('saveBtn');
const loadBtn  = document.getElementById('loadBtn');
const clearBtn = document.getElementById('clearBtn');
const exampleBtn = document.getElementById('exampleBtn');
const copyBtn  = document.getElementById('copyBtn');
const printBtn = document.getElementById('printBtn');
const statusMsg = document.getElementById('statusMsg');
const debugDump = document.getElementById('debugDump');

function getCurrentRules(){ 
  const id = parseInt(doorSel.value,10);
  if(!Array.isArray(allRules[id])) allRules[id]=[];
  return allRules[id]; 
}
function setCurrentRules(rules){ allRules[parseInt(doorSel.value,10)] = rules; }

function normalizeRule(rule){
  // Ensure days is array
  if(!Array.isArray(rule.days)) rule.days = [];
  // unique & sorted days
  rule.days = Array.from(new Set(rule.days.map(Number).filter(n=>Number.isInteger(n)&&n>=0&&n<=6))).sort((a,b)=>a-b);
  // time: ensure HH:MM
  if(typeof rule.time !== 'string') rule.time = '08:00';
  const m = rule.time.match(/^(\d{1,2}):(\d{2})$/);
  if(!m){ rule.time = '08:00'; }
  // action
  rule.action = (rule.action||'UNLOCK').toString().toUpperCase();
  if(rule.action !== 'UNLOCK' && rule.action !== 'LOCK') rule.action='UNLOCK';
  // note string
  if(typeof rule.note !== 'string') rule.note = '';
  return { days: rule.days, time: rule.time, action: rule.action, note: rule.note };
}

function ruleRow(rule, idx){
  // make sure rule.days exists
  if(!Array.isArray(rule.days)) rule.days = [];

  const frag = document.createDocumentFragment();

  // Zile
  const daysBox = document.createElement('div'); daysBox.className='days';
  dayNames.forEach((name,i)=>{
    const chip = document.createElement('label'); chip.className='chip';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = (rule.days||[]).includes(i);
    cb.addEventListener('change',()=>{
      if(!Array.isArray(rule.days)) rule.days=[];
      if(cb.checked){ if(!rule.days.includes(i)) rule.days.push(i); }
      else { rule.days = rule.days.filter(x=>x!==i); }
      // keep days normalized in UI
      rule.days = Array.from(new Set(rule.days)).sort((a,b)=>a-b);
      renderRules(); // re-render to update checkboxes order
    });
    chip.appendChild(cb); chip.append(name); daysBox.appendChild(chip);
  });

  // Ora
  const time = document.createElement('input'); time.type='time'; time.value = rule.time || '08:00';
  time.addEventListener('input',()=> rule.time = time.value);

  // Acțiune
  const act = document.createElement('select');
  ['UNLOCK','LOCK'].forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; act.appendChild(o); });
  act.value = rule.action || 'UNLOCK';
  act.addEventListener('change',()=> rule.action = act.value);

  // Notă
  const note = document.createElement('input'); note.type='text'; note.placeholder='opțional';
  note.value = rule.note || '';
  note.addEventListener('input',()=> rule.note = note.value);

  // Ștergere
  const del = document.createElement('button'); del.className='del'; del.textContent='✕';
  del.addEventListener('click',()=>{ getCurrentRules().splice(idx,1); renderRules(); });

  // în grid
  const w1=document.createElement('div'), w2=document.createElement('div'),
        w3=document.createElement('div'), w4=document.createElement('div'), w5=document.createElement('div');
  w1.appendChild(daysBox); w2.appendChild(time); w3.appendChild(act); w4.appendChild(note); w5.appendChild(del);
  frag.appendChild(w1); frag.appendChild(w2); frag.appendChild(w3); frag.appendChild(w4); frag.appendChild(w5);
  return frag;
}

function renderRules(){ 
  rulesEl.innerHTML='';
  getCurrentRules().forEach((r,i)=> rulesEl.appendChild(ruleRow(r,i)));
  updateDebug(); 
}

addBtn.onclick = ()=>{ 
  getCurrentRules().push({days:[0,1,2,3,4], time:'08:00', action:'UNLOCK', note:''}); 
  renderRules(); 
};
clearBtn.onclick = ()=>{ setCurrentRules([]); renderRules(); };
exampleBtn.onclick = ()=>{ setCurrentRules([
    {days:[0,1,2,3,4], time:'08:00', action:'UNLOCK', note:'deschidere L–V'},
    {days:[0,1,2,3,4], time:'18:00', action:'LOCK',   note:'închidere L–V'}
  ]); renderRules(); };
copyBtn.onclick = ()=>{ 
  const clone = JSON.parse(JSON.stringify(getCurrentRules()));
  for(let i=1;i<=6;i++){ allRules[i] = JSON.parse(JSON.stringify(clone)); }
  flash('Reguli copiate la toate ușile.');
  renderRules();
};

printBtn.onclick = ()=> {
  const json = normalizeRulesForPublish();
  console.log("PRINT rules JSON:", json);
  debugDump.textContent = JSON.stringify(json, null, 2);
  flash('JSON afișat în consola si preview.');
};

/* Normalizează și returnează payload */
function normalizeRulesForPublish(){
  const rules = getCurrentRules().map(r=>normalizeRule(r));
  // optional: filter invalid entries (eg. empty days)
  return { rules: rules };
}

/* Save → locker/<id>/schedule/set */
saveBtn.onclick = ()=>{ 
  const id = parseInt(doorSel.value,10);
  const payloadObj = normalizeRulesForPublish();
  const payload = JSON.stringify(payloadObj);
  // Debug logs
  console.log("PUBLISH -> topic:", `locker/${id}/schedule/set`);
  console.log("PUBLISH payload:", payload);
  console.log("PUBLISH len:", payload.length);
  debugDump.textContent = payload;
  client.publish(`locker/${id}/schedule/set`, payload);
  flash('Program trimis către ESP. Vezi consola pentru payload.', true); 
};

/* Load ← cere la locker/<id>/schedule/get */
loadBtn.onclick = ()=>{ 
  const id = parseInt(doorSel.value,10);
  client.publish(`locker/${id}/schedule/get`, "REQ");
  flash('Cerere program trimisă. Aștept răspunsul ESP.'); 
};

/* Recepție program curent */
client.on('message', (topic, payload)=>{ 
  const parts = topic.split('/');
  if (parts.length>=3 && parts[0]==='locker' && parts[2]==='schedule'){
    const id = parseInt(parts[1],10);
    try{
      const obj = JSON.parse(payload.toString());
      if(Array.isArray(obj.rules)){
        // normalize incoming rules elements
        const norm = obj.rules.map(r => normalizeRule(r));
        allRules[id] = norm;
      }
      if(id===parseInt(doorSel.value,10)){ renderRules(); flash('Program primit din ESP.'); }
      console.log("MQTT recv schedule for", id, obj);
    }catch(e){ console.error("Invalid JSON from ESP:", e); flash('JSON invalid de la ESP.', false); }
  }
});

function flash(msg, ok=true){ statusMsg.innerHTML = `<span class="${ok?'good':'warn'}">${msg}</span>`; setTimeout(()=>statusMsg.textContent='',2500); }
function updateDebug(){ debugDump.textContent = JSON.stringify(getCurrentRules(), null, 2); }

/* start */
renderRules();
</script>
</body>
</html>
